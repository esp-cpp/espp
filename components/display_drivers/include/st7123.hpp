#pragma once

#include <array>
#include <chrono>
#include <thread>

#include "display_drivers.hpp"

namespace espp {

class St7123 {
  // MADCTL bits (see Espressif driver)
  static constexpr uint8_t GS_BIT = 1 << 0; // Row mirror (Y)
  static constexpr uint8_t SS_BIT = 1 << 1; // Column mirror (X)
  static constexpr uint8_t BGR_BIT = 1 << 3;

public:
  enum class Command : uint8_t {
    NOP = 0x00,
    SWRESET = 0x01,
    RDDID = 0x04,
    SLPIN = 0x10,
    SLPOUT = 0x11,
    NORON = 0x13,
    INVOFF = 0x20,
    INVON = 0x21,
    DISPOFF = 0x28,
    DISPON = 0x29,
    CASET = 0x2A,
    RASET = 0x2B,
    RAMWR = 0x2C,
    RAMRD = 0x2E,
    MADCTL = 0x36,
    COLMOD = 0x3A,
  };

  static bool initialize(const display_drivers::Config &config) {
    write_command_ = config.write_command;
    read_command_ = config.read_command;
    lcd_send_lines_ = config.lcd_send_lines;
    reset_pin_ = config.reset_pin;
    dc_pin_ = config.data_command_pin;
    offset_x_ = config.offset_x;
    offset_y_ = config.offset_y;
    mirror_x_ = config.mirror_x;
    mirror_y_ = config.mirror_y;
    mirror_portrait_ = config.mirror_portrait;
    swap_xy_ = config.swap_xy;
    swap_color_order_ = config.swap_color_order;

    // Initialize display pins
    display_drivers::init_pins(reset_pin_, dc_pin_, config.reset_value);

    // MADCTL value
    uint8_t madctl = 0;
    if (mirror_x_)
      madctl |= GS_BIT;
    if (mirror_y_)
      madctl |= SS_BIT;
    if (swap_color_order_)
      madctl |= BGR_BIT;
    // Note: swap_xy_ not supported by ST7123 MADCTL

    // COLMOD value
    uint8_t colmod = 0x55; // 16bpp default
    switch (config.bits_per_pixel) {
    case 16:
      colmod = 0x55;
      break;
    case 18:
      colmod = 0x66;
      break;
    case 24:
      colmod = 0x77;
      break;
    default:
      break;
    }
    // ST7123 vendor-specific init sequence (from Espressif driver)
    using Cmd = display_drivers::DisplayInitCmd<>;
    std::array<Cmd, 27> init_cmds = {{
        {0x60, {0x71, 0x23, 0xa2}, 0},
        {0x60, {0x71, 0x23, 0xa3}, 0},
        {0x60, {0x71, 0x23, 0xa4}, 0},
        {0xA4, {0x31}, 0},
        {0xD7, {0x10, 0x0A, 0x10, 0x2A, 0x80, 0x80}, 0},
        {0x90, {0x71, 0x23, 0x5A, 0x20, 0x24, 0x09, 0x09}, 0},
        {0xA3,
         {0x80, 0x01, 0x88, 0x30, 0x05, 0x00, 0x00, 0x00, 0x00, 0x00, 0x46, 0x00, 0x00,
          0x1E, 0x5C, 0x1E, 0x80, 0x00, 0x4F, 0x05, 0x00, 0x00, 0x00, 0x00, 0x00, 0x46,
          0x00, 0x00, 0x1E, 0x5C, 0x1E, 0x80, 0x00, 0x6F, 0x58, 0x00, 0x00, 0x00, 0xFF},
         0},
        {0xA6,
         {0x03, 0x00, 0x24, 0x55, 0x36, 0x00, 0x39, 0x00, 0x6E, 0x6E, 0x91, 0xFF, 0x00, 0x24,
          0x55, 0x38, 0x00, 0x37, 0x00, 0x6E, 0x6E, 0x91, 0xFF, 0x00, 0x24, 0x11, 0x00, 0x00,
          0x00, 0x00, 0x6E, 0x6E, 0x91, 0xFF, 0x00, 0xEC, 0x11, 0x00, 0x03, 0x00, 0x03, 0x6E,
          0x6E, 0xFF, 0xFF, 0x00, 0x08, 0x80, 0x08, 0x80, 0x06, 0x00, 0x00, 0x00, 0x00},
         0},
        {0xA7,
         {0x19, 0x19, 0x80, 0x64, 0x40, 0x07, 0x16, 0x40, 0x00, 0x44, 0x03, 0x6E, 0x6E, 0x91, 0xFF,
          0x08, 0x80, 0x64, 0x40, 0x25, 0x34, 0x40, 0x00, 0x02, 0x01, 0x6E, 0x6E, 0x91, 0xFF, 0x08,
          0x80, 0x64, 0x40, 0x00, 0x00, 0x40, 0x00, 0x00, 0x00, 0x6E, 0x6E, 0x91, 0xFF, 0x08, 0x80,
          0x64, 0x40, 0x00, 0x00, 0x00, 0x00, 0x20, 0x00, 0x6E, 0x6E, 0x84, 0xFF, 0x08, 0x80, 0x44},
         0},
        {0xAC,
         {0x03, 0x19, 0x19, 0x18, 0x18, 0x06, 0x13, 0x13, 0x11, 0x11, 0x08, 0x08, 0x0A, 0x0A, 0x1C,
          0x1C, 0x07, 0x07, 0x00, 0x00, 0x02, 0x02, 0x01, 0x19, 0x19, 0x18, 0x18, 0x06, 0x12, 0x12,
          0x10, 0x10, 0x09, 0x09, 0x0B, 0x0B, 0x1C, 0x1C, 0x07, 0x07, 0x03, 0x03, 0x01, 0x01},
         0},
        {0xAD,
         {0xF0, 0x00, 0x46, 0x00, 0x03, 0x50, 0x50, 0xFF, 0xFF, 0xF0, 0x40, 0x06, 0x01,
          0x07, 0x42, 0x42, 0xFF, 0xFF, 0x01, 0x00, 0x00, 0xFF, 0xFF, 0xFF, 0xFF},
         0},
        {0xAE, {0xFE, 0x3F, 0x3F, 0xFE, 0x3F, 0x3F, 0x00}, 0},
        {0xB2,
         {0x15, 0x19, 0x05, 0x23, 0x49, 0xAF, 0x03, 0x2E, 0x5C, 0xD2, 0xFF, 0x10, 0x20, 0xFD, 0x20,
          0xC0, 0x00},
         0},
        {0xE8,
         {0x20, 0x6F, 0x04, 0x97, 0x97, 0x3E, 0x04, 0xDC, 0xDC, 0x3E, 0x06, 0xFA, 0x26, 0x3E},
         0},
        {0x75, {0x03, 0x04}, 0},
        {0xE7,
         {0x3B, 0x00, 0x00, 0x7C, 0xA1, 0x8C, 0x20, 0x1A, 0xF0, 0xB1, 0x50, 0x00,
          0x50, 0xB1, 0x50, 0xB1, 0x50, 0xD8, 0x00, 0x55, 0x00, 0xB1, 0x00, 0x45,
          0xC9, 0x6A, 0xFF, 0x5A, 0xD8, 0x18, 0x88, 0x15, 0xB1, 0x01, 0x01, 0x77},
         0},
        {0xEA, {0x13, 0x00, 0x04, 0x00, 0x00, 0x00, 0x00, 0x2C}, 0},
        {0xB0, {0x22, 0x43, 0x11, 0x61, 0x25, 0x43, 0x43}, 0},
        {0xB7, {0x00, 0x00, 0x73, 0x73}, 0},
        {0xBF, {0xA6, 0xAA}, 0},
        {0xA9, {0x00, 0x00, 0x73, 0xFF, 0x00, 0x00, 0x03, 0x00, 0x00, 0x03}, 0},
        {0xC8,
         {0x00, 0x00, 0x10, 0x1F, 0x36, 0x00, 0x5D, 0x04, 0x9D, 0x05, 0x10, 0xF2, 0x06,
          0x60, 0x03, 0x11, 0xAD, 0x00, 0xEF, 0x01, 0x22, 0x2E, 0x0E, 0x74, 0x08, 0x32,
          0xDC, 0x09, 0x33, 0x0F, 0xF3, 0x77, 0x0D, 0xB0, 0xDC, 0x03, 0xFF},
         0},
        {0xC9,
         {0x00, 0x00, 0x10, 0x1F, 0x36, 0x00, 0x5D, 0x04, 0x9D, 0x05, 0x10, 0xF2, 0x06,
          0x60, 0x03, 0x11, 0xAD, 0x00, 0xEF, 0x01, 0x22, 0x2E, 0x0E, 0x74, 0x08, 0x32,
          0xDC, 0x09, 0x33, 0x0F, 0xF3, 0x77, 0x0D, 0xB0, 0xDC, 0x03, 0xFF},
         0},
        {0x11, {0x00}, 100},
        {0x29, {0x00}, 0},
        {0x35, {0x00}, 100},
    }};

    // Send vendor-specific init sequence
    for (const auto &cmd : init_cmds) {
      write_command_(cmd.command, std::span<const uint8_t>(cmd.parameters), 0);
      if (cmd.delay_ms > 0) {
        std::this_thread::sleep_for(std::chrono::milliseconds(cmd.delay_ms));
      }
      std::this_thread::sleep_for(std::chrono::milliseconds(5));
    }

    // Set MADCTL (mirror/color order)
    write_command_(static_cast<uint8_t>(Command::MADCTL), std::span<const uint8_t>(&madctl, 1), 0);
    // Set COLMOD (color depth)
    write_command_(static_cast<uint8_t>(Command::COLMOD), std::span<const uint8_t>(&colmod, 1), 0);

    return true;
  }

  static constexpr const char *id() { return "ST7123"; }

protected:
  static display_drivers::write_command_fn write_command_;
  static display_drivers::read_command_fn read_command_;
  static display_drivers::send_lines_fn lcd_send_lines_;
  static gpio_num_t reset_pin_;
  static gpio_num_t dc_pin_;
  static int offset_x_;
  static int offset_y_;
  static bool swap_xy_;
  static bool mirror_x_;
  static bool mirror_y_;
  static bool mirror_portrait_;
  static bool swap_color_order_;
};

inline display_drivers::write_command_fn St7123::write_command_{nullptr};
inline display_drivers::read_command_fn St7123::read_command_{nullptr};
inline display_drivers::send_lines_fn St7123::lcd_send_lines_{nullptr};
inline gpio_num_t St7123::reset_pin_{GPIO_NUM_NC};
inline gpio_num_t St7123::dc_pin_{GPIO_NUM_NC};
inline int St7123::offset_x_{0};
inline int St7123::offset_y_{0};
inline bool St7123::swap_xy_{false};
inline bool St7123::mirror_x_{false};
inline bool St7123::mirror_y_{false};
inline bool St7123::mirror_portrait_{false};
inline bool St7123::swap_color_order_{false};

} // namespace espp
